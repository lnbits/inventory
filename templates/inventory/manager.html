{% extends "public.html" %} {% block toolbar_title %} Stock Manager {% endblock
%} {% block page %}
<div class="row justify-center">
  <div class="col-12">
    <q-table
      :columns="displayedColumns"
      :rows="filteredItems"
      :loading="loadingItems"
      :pagination.sync="itemsTable.pagination"
      row-key="id"
      :filter="itemsTable.search"
      no-data-label="No items..."
      no-results-label="No results found"
      flat
      bordered
      dense
    >
      <template v-slot:top>
        <div class="row items-center q-gutter-xs q-px-xs q-pt-xs full-width">
          <q-btn
            round
            dense
            color="primary"
            icon="add"
            @click="showItemDialog()"
          >
            <q-tooltip>Add an item</q-tooltip>
          </q-btn>
          <q-space></q-space>
          <q-input
            standout
            dense
            debounce="300"
            color="primary"
            v-model="itemsTable.search"
            placeholder="Search items"
          >
            <template v-slot:append>
              <q-icon name="search" />
            </template>
          </q-input>
        </div>
      </template>
      <template v-slot:body-cell-is_active="props">
        <q-td :props="props" class="auto-width">
          <q-icon
            name="circle"
            size="10px"
            :color="props.row.is_active ? 'positive' : 'grey-6'"
          />
        </q-td>
      </template>
      <template v-slot:body-cell-name="props">
        <q-td :props="props">
          <div
            v-if="$q.screen.lt.md"
            class="ellipsis"
            style="max-width: 160px"
            v-text="props.value"
          ></div>
          <q-tooltip v-if="$q.screen.lt.md" v-text="props.value"></q-tooltip>
          <div v-else v-text="props.value"></div>
        </q-td>
      </template>
      <template v-slot:body-cell-quantity_in_stock="props">
        <q-td :props="props">
          <div class="row items-center no-wrap q-gutter-sm">
            <q-input
              dense
              type="number"
              min="0"
              :input-attr="{ size: 5 }"
              v-model.number="props.row._quantityEdit"
            ></q-input>
            <q-btn
              round
              dense
              color="primary"
              icon="save"
              :loading="updatingQuantities[props.row.id]"
              :disable="
                    props.row._quantityEdit === props.row.quantity_in_stock ||
                    updatingQuantities[props.row.id]
                  "
              @click="updateItemQuantity(props.row)"
            ></q-btn>
          </div>
        </q-td>
      </template>
    </q-table>
  </div>
  {% include "inventory/_dialogs.html" %}
</div>
{% endblock %} {% block scripts %}
<script>
  const manager = JSON.parse({{ manager | tojson | safe }})
  const inventory = JSON.parse({{ inventory | tojson | safe }})
</script>
<script>
  window.app = Vue.createApp({
    el: '#vue',
    mixins: [windowMixin],
    data() {
      return {
        inventory: null,
        manager: null,
        managerAllowedTags: [],
        items: [],
        updatingQuantities: {},
        loadingItems: false,
        itemsTable: {
          columns: [
            {
              name: 'is_active',
              align: 'center',
              label: '',
              field: 'is_active',
              sortable: false,
              classes: 'auto-width',
              headerClasses: 'auto-width',
              format: (_, row) => (row.is_active === true ? 'ðŸŸ¢' : 'âšª')
            },
            {
              name: 'name',
              align: 'left',
              label: 'Name',
              field: 'name',
              sortable: true
            },
            {
              name: 'description',
              align: 'left',
              label: 'Description',
              field: 'description',
              sortable: false,
              format: val => (val || '').substring(0, 50)
            },
            {
              name: 'price',
              align: 'left',
              label: 'Price',
              field: 'price',
              sortable: true,
              format: (_, row) => {
                const currency = this.inventory?.currency
                const normalized = this.normalizeCurrency(currency)
                return this.checkIsSat(normalized)
                  ? `${row.price} sats`
                  : LNbits.utils.formatCurrency(row.price, normalized)
              }
            },
            {
              name: 'discount',
              align: 'left',
              label: 'Discount',
              field: 'discount_percentage',
              sortable: true,
              format: val => (val ? `${val}%` : '')
            },
            {
              name: 'quantity_in_stock',
              align: 'left',
              label: 'Quantity',
              field: 'quantity_in_stock',
              sortable: true
            },
            {
              name: 'tags',
              align: 'left',
              label: 'Tags',
              field: 'tags',
              sortable: true,
              format: val => (val ? val.toString() : '')
            },
            {
              name: 'created_at',
              align: 'left',
              label: 'Created At',
              field: 'created_at',
              format: val => LNbits.utils.formatDateString(val),
              sortable: true
            },
            {
              name: 'id',
              align: 'left',
              label: 'ID',
              field: 'id',
              sortable: true
            }
          ],
          pagination: {
            rowsPerPage: 10,
            page: 1,
            rowsNumber: 10
          },
          search: ''
        },
        itemDialog: {
          show: false,
          data: {},
          gallery: [],
          currency: null
        }
      }
    },
    async created() {
      this.manager = manager
      this.inventory = inventory
      this.inventory.tags = fromCsv(this.inventory.tags)
      this.inventory.omit_tags = fromCsv(this.inventory.omit_tags)
      const allowed = this.manager.tags ? fromCsv(this.manager.tags) : null
      this.managerAllowedTags = allowed || [...this.inventory.tags]
      // Limit selectable tags to what the manager is allowed to use
      this.inventory.tags = [...this.managerAllowedTags]
      this.itemDialog.currency = this.normalizeCurrency(this.inventory.currency)
      this.itemDialog.data.currency = this.itemDialog.currency
      await this.getManagerItems()
      console.log('Manager page created', this.g)
    },
    computed: {
      displayedColumns() {
        if (this.$q?.screen?.lt?.md) {
          return this.itemsTable.columns.filter(column =>
            ['is_active', 'name', 'quantity_in_stock'].includes(column.name)
          )
        }
        return this.itemsTable.columns
      },
      filteredItems() {
        const term = (this.itemsTable.search || '').toLowerCase().trim()
        if (!term) return this.items
        const match = value =>
          (value || '').toString().toLowerCase().includes(term)

        return this.items.filter(item => {
          return (
            match(item.name) ||
            match(item.description) ||
            match(item.id) ||
            match(item.price) ||
            match(item.tags && item.tags.join(','))
          )
        })
      },
      allowCurrencyDecimals() {
        return (this.getCurrencyDecimals(this.itemDialog.currency) || 0) > 0
      }
    },
    methods: {
      async getManagerItems() {
        this.loadingItems = true
        try {
          const response = await LNbits.api.request(
            'GET',
            `/inventory/api/v1/managers/${manager.id}/items`
          )
          this.itemsTable.rowsNumber = response.data.length
          const mappedItems = response.data.map(item => {
            const mapped = mapItems(item)
            mapped._quantityEdit =
              mapped.quantity_in_stock !== null &&
              mapped.quantity_in_stock !== undefined
                ? mapped.quantity_in_stock
                : 0
            return mapped
          })
          console.log('Fetched manager items:', mappedItems)
          this.items = mappedItems
        } catch (error) {
          console.error('Error fetching manager items:', error)
          LNbits.utils.notifyError('Failed to load items for this manager.')
        } finally {
          this.loadingItems = false
        }
      },
      normalizeCurrency(currency) {
        if (!currency) return 'sat'
        return ['sat', 'sats'].includes(currency.toLowerCase())
          ? 'sat'
          : currency.toUpperCase()
      },
      checkIsSat(currency) {
        return ['sat', 'sats'].includes((currency || '').toLowerCase())
      },
      getCurrencyDecimals(currency) {
        const normalized = this.normalizeCurrency(currency)
        if (this.checkIsSat(normalized)) return 0
        try {
          const resolved = new Intl.NumberFormat(window.i18n.global.locale, {
            style: 'currency',
            currency: normalized
          }).resolvedOptions()
          return resolved.maximumFractionDigits || 0
        } catch (error) {
          return 2
        }
      },
      showItemDialog(id) {
        this.itemDialog.show = true
        // Ensure tag options and defaults are set
        const currency =
          this.inventory && this.inventory.currency
            ? this.normalizeCurrency(this.inventory.currency)
            : 'sat'
        this.itemDialog.currency = currency
        const defaultTags =
          this.managerAllowedTags && this.managerAllowedTags.length
            ? [...this.managerAllowedTags]
            : []
        const defaultOmitTags = Array.isArray(this.inventory.omit_tags)
          ? [...this.inventory.omit_tags]
          : []
        if (id) {
          const item = this.items.find(it => it.id === id)
          this.itemDialog.data = {
            ...item,
            currency,
            tags: item.tags && item.tags.length ? [...item.tags] : defaultTags,
            omit_tags:
              item.omit_tags && item.omit_tags.length
                ? [...item.omit_tags]
                : defaultOmitTags
          }
          this.itemDialog.gallery = item.images.map(img => {
            return {
              assetId: null,
              preview: img,
              file: null,
              isNew: false
            }
          })
          return
        }
        this.itemDialog.data = {
          currency,
          tags: defaultTags,
          omit_tags: defaultOmitTags
        }
      },
      closeItemDialog() {
        this.itemDialog.show = false
        this.itemDialog.data = {}
        this.itemDialog.gallery.forEach(p => {
          // cleanup object URLs
          if (p.preview && p.isNew) URL.revokeObjectURL(p.preview)
        })
        this.itemDialog.gallery = []
      },
      submitItemData() {
        const data = this.itemDialog.data
        data.tags = toCsv(data.tags)
        data.omit_tags = toCsv(data.omit_tags)
        if (data.id) {
          this.updateItem(data)
        } else {
          this.addItem()
        }
      },
      async addItem() {
        this.itemDialog.data.inventory_id = this.inventory.id
        const base64List = await Promise.all(
          this.itemDialog.gallery.map(p => fileToBase64(p.file))
        )
        try {
          this.itemDialog.data.images = toCsv(base64List, '|||')
          const {data} = await LNbits.api.request(
            'POST',
            `/inventory/api/v1/managers/${this.manager.id}/item`,
            null,
            this.itemDialog.data
          )
          console.log('Item added:', data)
          const mapped = mapItems(data)
          mapped._quantityEdit =
            mapped.quantity_in_stock !== null &&
            mapped.quantity_in_stock !== undefined
              ? mapped.quantity_in_stock
              : 0
          this.items = [...this.items, mapped]
        } catch (error) {
          console.error('Error adding item:', error)
          LNbits.utils.notifyError(error)
        } finally {
          this.closeItemDialog()
        }
      },
      async updateItem(data) {
        const newPhotos = this.itemDialog.gallery.filter(p => p.isNew && p.file)
        let newBase64 = []

        if (newPhotos.length > 0) {
          newBase64 = await Promise.all(
            newPhotos.map(p => fileToBase64(p.file))
          )
        }

        const finalImages = [
          ...this.itemDialog.gallery.filter(p => !p.isNew).map(p => p.file),
          ...newBase64
        ]

        data.images = toCsv(finalImages, '|||')

        try {
          const {data: updatedItem} = await LNbits.api.request(
            'PUT',
            `/inventory/api/v1/managers/${this.manager.id}/item/${data.id}`,
            null,
            data
          )
          const mapped = mapItems(updatedItem)
          mapped._quantityEdit =
            mapped.quantity_in_stock !== null &&
            mapped.quantity_in_stock !== undefined
              ? mapped.quantity_in_stock
              : 0
          this.items = this.items.map(item =>
            item.id === mapped.id ? mapped : item
          )
        } catch (error) {
          console.error('Error updating item:', error)
          LNbits.utils.notifyError(error)
        } finally {
          this.closeItemDialog()
        }
      },
      async deleteItem(id) {
        this.$q
          .dialog({
            title: 'Confirm Deletion',
            message: 'Are you sure you want to delete this item?',
            cancel: true,
            persistent: true
          })
          .onOk(async () => {
            try {
              await LNbits.api.request(
                'DELETE',
                `/inventory/api/v1/managers/${this.manager.id}/item/${id}`
              )
              this.items = this.items.filter(item => item.id !== id)
            } catch (error) {
              console.error('Error deleting item:', error)
              LNbits.utils.notifyError(error)
            }
          })
      },
      async updateItemQuantity(item) {
        this.updatingQuantities = {
          ...this.updatingQuantities,
          [item.id]: true
        }
        try {
          const payload = {
            inventory_id: this.inventory.id,
            quantity_in_stock: Number(item._quantityEdit)
          }
          const {data} = await LNbits.api.request(
            'PUT',
            `/inventory/api/v1/managers/${this.manager.id}/item/${item.id}/quantity`,
            null,
            payload
          )
          const mapped = mapItems(data)
          mapped._quantityEdit =
            mapped.quantity_in_stock !== null &&
            mapped.quantity_in_stock !== undefined
              ? mapped.quantity_in_stock
              : 0
          this.items = this.items.map(it => (it.id === mapped.id ? mapped : it))
        } catch (error) {
          console.error('Error updating item quantity:', error)
          LNbits.utils.notifyError('Failed to update quantity.')
        } finally {
          this.updatingQuantities = {
            ...this.updatingQuantities,
            [item.id]: false
          }
        }
      }
    }
  })
</script>
<script src="{{ static_url_for('inventory/static', path='js/utils.js') }}"></script>
<script src="{{ static_url_for('inventory/static', path='components/photo-gallery-form.js') }}"></script>
{% endblock %}
